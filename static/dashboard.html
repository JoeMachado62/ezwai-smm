<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Content Generator - Dashboard</title>
    <link rel="icon" type="image/png" href="/static/MY_CONTENT_GEN.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #6B5DD3 0%, #4A9FE8 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0;
            }
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-height: 80px;
            width: auto;
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5em;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .header-logo {
                max-height: 40px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .card {
                padding: 20px;
                border-radius: 15px;
            }
        }

        .card h2 {
            font-size: 1.8em;
            color: #1a1a1a;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .card h2 {
                font-size: 1.4em;
            }
        }

        .card-icon {
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6B5DD3;
            box-shadow: 0 0 0 3px rgba(107, 93, 211, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #FF6B4A 0%, #e55a00 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 74, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .btn {
                font-size: 1em;
                padding: 14px 24px;
            }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #6B5DD3;
            border: 2px solid #6B5DD3;
        }

        .btn-secondary:hover {
            background: #6B5DD3;
            color: white;
        }

        .style-template-btn {
            background: linear-gradient(135deg, #4A9FE8 0%, #6B5DD3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .style-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 159, 232, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #4A9FE8 0%, #6B5DD3 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .modal-body {
            padding: 30px;
        }

        .template-item {
            padding: 18px;
            margin-bottom: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-item:hover {
            border-color: #6B5DD3;
            background-color: #f5f3ff;
            transform: translateX(5px);
        }

        .template-name {
            font-weight: 700;
            font-size: 16px;
            color: #6B5DD3;
            margin-bottom: 8px;
        }

        .template-preview {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .close-modal {
            color: white;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            opacity: 0.8;
        }

        .progress-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4A9FE8 0%, #6B5DD3 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-text {
            color: #666;
            font-size: 0.95em;
            text-align: center;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-info {
            background: #e8f4fd;
            color: #0c5460;
            border-left: 4px solid #4A9FE8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #4A9FE8 0%, #6B5DD3 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .stat-card {
                padding: 18px 15px;
            }
        }

        .stat-card.credits {
            background: linear-gradient(135deg, #FF6B4A 0%, #e55a00 100%);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .stat-card.credits:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 74, 0.3);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            .stat-number {
                font-size: 1.8em;
            }
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @media (max-width: 600px) {
            .stat-label {
                font-size: 0.8em;
            }
        }

        .credit-action {
            font-size: 0.75em;
            opacity: 0.9;
            margin-top: 8px;
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .credit-action {
                font-size: 0.7em;
            }
        }

        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Thicker, more visible scrollbar for mobile */
        .tab-navigation::-webkit-scrollbar {
            height: 8px;
        }

        .tab-navigation::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
            margin: 0 10px;
        }

        .tab-navigation::-webkit-scrollbar-thumb {
            background: #6B5DD3;
            border-radius: 10px;
        }

        .tab-navigation::-webkit-scrollbar-thumb:hover {
            background: #5a4dc3;
        }

        /* For Firefox */
        .tab-navigation {
            scrollbar-width: thick;
            scrollbar-color: #6B5DD3 #f0f0f0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            color: #666;
            border-radius: 10px;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        @media (max-width: 768px) {
            .tab-btn {
                font-size: 0.9em;
                padding: 12px 15px;
            }
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FF6B4A 0%, #e55a00 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .schedule-grid {
            display: grid;
            gap: 15px;
        }

        .schedule-item {
            display: grid;
            grid-template-columns: 150px 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .schedule-item {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .schedule-item > * {
                width: 100%;
            }
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4A9FE8;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .query-list {
            display: grid;
            gap: 12px;
        }

        .query-item {
            display: flex;
            gap: 10px;
        }

        .query-item input {
            flex: 1;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9em;
            width: auto;
        }

        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            border-radius: 20px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .preview-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 25px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }

        .close-preview {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .preview-body {
            padding: 40px;
        }

        .profile-menu-container {
            position: relative;
            margin-left: auto;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }

        @media (max-width: 600px) {
            .profile-trigger {
                padding: 6px 12px;
                gap: 6px;
            }

            .profile-trigger span {
                font-size: 0.9em;
                max-width: 80px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .profile-trigger:hover {
            border-color: #6B5DD3;
            box-shadow: 0 4px 12px rgba(107, 93, 211, 0.2);
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(135deg, #6B5DD3 0%, #4A9FE8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .profile-dropdown {
            position: absolute;
            right: 0;
            top: 50px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-dropdown a:last-child {
            border-bottom: none;
        }

        .profile-dropdown a:hover {
            background: #f8f9ff;
            color: #6B5DD3;
        }

        /* Tutorial Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .tutorial-steps {
            margin-top: 30px;
        }

        .step {
            display: flex;
            margin-bottom: 25px;
            align-items: flex-start;
        }

        .step-number {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            margin-right: 20px;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            margin: 0 0 8px 0;
            color: #1f2937;
        }

        .step-content p {
            margin: 5px 0;
            color: #6b7280;
        }

        .step-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .info-banner {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
        }

        .info-banner strong {
            display: block;
            margin-bottom: 8px;
            color: #1e40af;
        }

        .info-banner p {
            margin: 8px 0;
            color: #1e3a8a;
        }

        .btn-text {
            background: none;
            border: none;
            color: #7c3aed;
            cursor: pointer;
            font-size: 14px;
            padding: 5px 10px;
        }

        .btn-text:hover {
            color: #6d28d9;
            text-decoration: underline;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .status-message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .status-message.info {
            background-color: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .help-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .card-header {
            margin-bottom: 15px;
        }

        .card-body {
            /* Additional styling if needed */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/MY_CONTENT_GEN%20WEBLOGO.png" alt="My Content Generator Logo" class="header-logo">
            <div class="header-text">
                <h1>My Content Generator</h1>
                <p>AI-Powered Blog Content for WordPress</p>
            </div>
            <div class="profile-menu-container">
                <div class="profile-trigger" onclick="toggleProfileMenu()">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <span id="profileName">User</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="currentColor">
                        <path d="M1 1l5 5 5-5"/>
                    </svg>
                </div>
                <div id="profileDropdown" class="profile-dropdown" style="display: none;">
                    <a href="#" onclick="openManageProfile(); return false;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/>
                        </svg>
                        Manage Profile
                    </a>
                    <a href="#" onclick="handleLogout(); return false;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M3 0v1H0v2h3v13h10V3h3V1h-3V0H3zm2 3h6v11H5V3z"/>
                        </svg>
                        Log Out
                    </a>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card credits" onclick="switchTab('billing')" title="Click to manage credits">
                <div class="stat-number"><span id="creditBalance">0</span> credits</div>
                <div class="stat-label">Credit Balance</div>
                <div class="credit-action">💳 Click to Buy Credits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPosts">0</div>
                <div class="stat-label">Total Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="scheduledPosts">0</div>
                <div class="stat-label">Scheduled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeQueries">0</div>
                <div class="stat-label">Active Topics</div>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('create')">✨ Create Post</button>
            <button class="tab-btn" onclick="switchTab('queries')">📝 Topics</button>
            <button class="tab-btn" onclick="switchTab('schedule')">📅 Schedule</button>
            <button class="tab-btn" onclick="switchTab('articles')">📚 Article Library</button>
            <button class="tab-btn" onclick="switchTab('images')">🖼️ Image Library</button>
            <button class="tab-btn" onclick="switchTab('billing')">💳 Credits & Billing</button>
            <button class="tab-btn" onclick="switchTab('settings')">⚙️ Settings</button>
        </div>

        <!-- Create Post Tab -->
        <div id="createTab" class="tab-content active">
            <div class="card">
                <h2><span class="card-icon">✍️</span> Create Magazine-Style Article</h2>

                <form id="createPostForm">
                    <div class="form-group">
                        <label for="postTopic">Article Topic or News Query</label>
                        <textarea
                            id="postTopic"
                            placeholder="E.g., 'Latest trends in artificial intelligence for small businesses'"
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="systemPrompt">
                            Writing Style & Instructions
                            <button type="button" class="style-template-btn" onclick="showStyleTemplates()">
                                📋 Style Templates
                            </button>
                        </label>
                        <textarea
                            id="systemPrompt"
                            placeholder="E.g., 'Write in a professional but conversational tone, targeting small business owners. Include practical examples and actionable tips.'"
                        ></textarea>
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <input type="checkbox" id="localModeCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="localModeCheckbox" style="margin: 0; cursor: pointer; font-weight: 500;">
                            📥 Create downloadable article (no WordPress required)
                        </label>
                    </div>
                    <p style="font-size: 13px; color: #666; margin: -5px 0 15px 0; padding-left: 15px;">
                        <strong>Note:</strong> If WordPress is not configured, this mode will be used automatically.
                        Check this box to always create a downloadable HTML file instead of publishing to WordPress.
                    </p>

                    <button type="submit" class="btn" id="createBtn">
                        🚀 Generate Magazine Article (1500+ words)
                    </button>
                </form>

                <div class="progress-section" id="progressSection">
                    <div class="progress-text" id="progressText">Initializing...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <div id="statusMessage"></div>
            </div>
        </div>

        <!-- Topics Tab -->
        <div id="queriesTab" class="tab-content">
            <div class="card">
                <h2><span class="card-icon">📝</span> Content Topics</h2>
                <p style="margin-bottom: 25px; color: #666;">
                    Add up to 10 topics. The system will rotate through them for scheduled posts.
                </p>

                <div class="query-list" id="queryList">
                    <!-- Queries will be populated here -->
                </div>

                <button class="btn" onclick="saveQueries()" style="margin-top: 20px;">
                    💾 Save Topics
                </button>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="scheduleTab" class="tab-content">
            <div class="card">
                <h2><span class="card-icon">📅</span> Publishing Schedule</h2>
                <p style="margin-bottom: 25px; color: #666;">
                    Configure when to automatically publish articles (up to 2 times per day)
                </p>

                <div class="schedule-grid" id="scheduleGrid">
                    <!-- Schedule items will be populated here -->
                </div>

                <button class="btn" onclick="saveSchedule()" style="margin-top: 20px;">
                    💾 Save Schedule
                </button>
            </div>
        </div>

        <!-- Article Library Tab -->
        <div id="articlesTab" class="tab-content">
            <div class="card">
                <h2><span class="card-icon">📚</span> Article Library</h2>

                <!-- Search and Filters -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input
                        type="text"
                        id="articleSearch"
                        placeholder="🔍 Search articles by title..."
                        style="flex: 1; min-width: 250px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;"
                        onkeyup="searchArticles()"
                    />

                    <select id="articleStatusFilter" onchange="filterArticles()" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">All Statuses</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                        <option value="local">Local</option>
                        <option value="failed">Failed</option>
                    </select>

                    <select id="articleModeFilter" onchange="filterArticles()" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">All Modes</option>
                        <option value="wordpress">WordPress</option>
                        <option value="local">Local</option>
                    </select>

                    <select id="articleSortOrder" onchange="filterArticles()" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="title">By Title</option>
                    </select>
                </div>

                <!-- Article Grid -->
                <div id="articleGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 25px;">
                    <p style="color: #666; text-align: center; padding: 40px;">Loading articles...</p>
                </div>

                <!-- Pagination -->
                <div id="articlePagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Image Library Tab -->
        <div id="imagesTab" class="tab-content">
            <div class="card">
                <h2><span class="card-icon">🖼️</span> Image Library</h2>

                <!-- Search and Filters -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input
                        type="text"
                        id="imageSearch"
                        placeholder="🔍 Search images by prompt..."
                        style="flex: 1; min-width: 250px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;"
                        onkeyup="searchImages()"
                    />

                    <select id="imageTypeFilter" onchange="filterImages()" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="">All Types</option>
                        <option value="hero">Hero Images</option>
                        <option value="section">Section Images</option>
                    </select>

                    <select id="imageSortOrder" onchange="filterImages()" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>

                <!-- Image Grid -->
                <div id="imageGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 25px;">
                    <p style="color: #666; text-align: center; padding: 40px;">Loading images...</p>
                </div>

                <!-- Pagination -->
                <div id="imagePagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Billing Tab -->
        <div id="billingTab" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h2><span class="card-icon">💰</span> Buy Credits</h2>

                    <div class="form-group">
                        <label>Select Credit Package</label>
                        <select id="creditPackage" style="font-size: 1.1em; padding: 16px;">
                            <option value="10">$10 - Starter (5 articles @ $1.99 each)</option>
                            <option value="25" selected>$25 - Basic (12 articles @ $1.99 each)</option>
                            <option value="50">$50 - Plus (25 articles @ $1.99 each)</option>
                            <option value="100">$100 - Pro (57 articles @ $1.75 each)</option>
                            <option value="250">$250 - Business (166 articles @ $1.50 each)</option>
                            <option value="500">$500 - Premium (400 articles @ $1.25 each)</option>
                            <option value="1000">$1000 - Enterprise (1010 articles @ $0.99 each)</option>
                        </select>
                    </div>

                    <button class="btn" onclick="purchaseCredits()">
                        🛒 Purchase Credits
                    </button>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 12px;">
                        <h3 style="font-size: 1.2em; margin-bottom: 15px;">💳 Current Balance</h3>
                        <p style="font-size: 2em; font-weight: 700; color: #ff6b11; margin: 10px 0;">
                            <span id="currentBalance">0</span> credits
                        </p>
                        <p style="color: #666; font-size: 0.9em;">
                            Available articles: <strong id="estimatedArticles">0</strong>
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">🔄</span> Auto-Recharge Settings</h2>
                    <p style="color: #666; margin-bottom: 25px;">
                        Automatically purchase credits when your balance runs low.
                    </p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" id="autoRechargeEnabled" style="width: 24px; height: 24px; cursor: pointer;">
                            <span style="font-weight: 600;">Enable Auto-Recharge</span>
                        </label>
                    </div>

                    <div id="autoRechargeSettings" style="display: none; margin-top: 20px;">
                        <div class="form-group">
                            <label>Recharge When Balance Falls Below</label>
                            <select id="autoRechargeThreshold" style="font-size: 1.05em;">
                                <option value="5">$5.00</option>
                                <option value="10" selected>$10.00</option>
                                <option value="25">$25.00</option>
                                <option value="50">$50.00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Recharge Amount</label>
                            <select id="autoRechargeAmount" style="font-size: 1.05em;">
                                <option value="25" selected>$25.00</option>
                                <option value="50">$50.00</option>
                                <option value="100">$100.00</option>
                                <option value="250">$250.00</option>
                            </select>
                        </div>

                        <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">
                            <p style="color: #856404; font-size: 0.9em; margin: 0;">
                                ⚠️ You'll be charged automatically when your balance drops below the threshold.
                            </p>
                        </div>
                    </div>

                    <button class="btn" onclick="saveAutoRecharge()">
                        💾 Save Auto-Recharge Settings
                    </button>
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h2><span class="card-icon">📊</span> Transaction History</h2>
                <div id="transactionHistory" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #999; text-align: center; padding: 40px;">
                        Loading transactions...
                    </p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="dashboard-grid">
                <!-- WordPress Integration Section -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="card-icon">🌐</span> WordPress Integration</h2>
                        <p class="help-text">Connect your WordPress site using an Application Password</p>
                    </div>
                    <div class="card-body">
                        <div class="info-banner" style="margin-bottom: 20px;">
                            <strong>ℹ️ What is an Application Password?</strong>
                            <p>Application Passwords are built into WordPress 5.6+ and provide a secure way to connect apps without exposing your main password.</p>
                            <button type="button" class="btn-secondary" onclick="showAppPasswordTutorial()">
                                📺 Watch Tutorial (2 min)
                            </button>
                        </div>

                        <form id="wordpressForm" onsubmit="saveWordPressSettings(event)">
                            <div class="form-group">
                                <label for="wpUrl">WordPress Site URL</label>
                                <input
                                    type="url"
                                    id="wpUrl"
                                    class="form-control"
                                    placeholder="https://yoursite.com"
                                    pattern="https?://.+"
                                    title="Must start with http:// or https://"
                                />
                                <small class="help-text">Enter your main site URL (we'll handle the rest)</small>
                            </div>

                            <div class="form-group">
                                <label for="wpPassword">Application Password</label>
                                <div style="position: relative;">
                                    <input
                                        type="password"
                                        id="wpPassword"
                                        class="form-control"
                                        placeholder="xxxx xxxx xxxx xxxx xxxx xxxx"
                                        style="padding-right: 100px;"
                                    />
                                    <button
                                        type="button"
                                        class="btn-text"
                                        onclick="togglePasswordVisibility('wpPassword')"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);"
                                    >
                                        👁️ Show
                                    </button>
                                </div>
                                <small class="help-text">Create one in WordPress: Users → Profile → Application Passwords</small>
                            </div>

                            <div class="button-group">
                                <button type="button" class="btn-secondary" onclick="testWordPressConnection()">
                                    🔌 Test Connection
                                </button>
                                <button type="submit" class="btn">
                                    💾 Save Settings
                                </button>
                            </div>

                            <div id="wordpressStatus" class="status-message" style="display: none;"></div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">🎨</span> Brand Customization</h2>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                        Customize your article colors or use EZWAi defaults (Teal & Orange)
                    </p>

                    <div class="form-group">
                        <label for="brandPrimary">Primary Brand Color (Headers/Borders)</label>
                        <div style="display: flex; gap: 12px; align-items: stretch;">
                            <div style="position: relative;">
                                <input
                                    type="color"
                                    id="brandPrimaryPicker"
                                    value="#6B5DD3"
                                    title="Click to open color picker"
                                    style="
                                        width: 80px;
                                        height: 48px;
                                        border: 2px solid #ddd;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        padding: 2px;
                                    "
                                />
                                <div style="
                                    position: absolute;
                                    bottom: -20px;
                                    left: 0;
                                    right: 0;
                                    text-align: center;
                                    font-size: 0.75rem;
                                    color: #666;
                                ">Pick Color</div>
                            </div>
                            <input
                                type="text"
                                id="brandPrimary"
                                value="#6B5DD3"
                                pattern="^#[0-9A-Fa-f]{6}$"
                                placeholder="#6B5DD3"
                                title="Or type hex color code"
                                style="flex: 1; font-family: monospace; font-size: 1rem;"
                            />
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 32px;">
                        <label for="brandAccent">Accent Color (Buttons/Highlights)</label>
                        <div style="display: flex; gap: 12px; align-items: stretch;">
                            <div style="position: relative;">
                                <input
                                    type="color"
                                    id="brandAccentPicker"
                                    value="#FF6B4A"
                                    title="Click to open color picker"
                                    style="
                                        width: 80px;
                                        height: 48px;
                                        border: 2px solid #ddd;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        padding: 2px;
                                    "
                                />
                                <div style="
                                    position: absolute;
                                    bottom: -20px;
                                    left: 0;
                                    right: 0;
                                    text-align: center;
                                    font-size: 0.75rem;
                                    color: #666;
                                ">Pick Color</div>
                            </div>
                            <input
                                type="text"
                                id="brandAccent"
                                value="#FF6B4A"
                                pattern="^#[0-9A-Fa-f]{6}$"
                                placeholder="#FF6B4A"
                                title="Or type hex color code"
                                style="flex: 1; font-family: monospace; font-size: 1rem;"
                            />
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #eee;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="useDefaultBranding" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Reset to My Content Generator Default Colors</span>
                        </label>
                        <p style="color: #999; font-size: 0.85rem; margin-top: 8px; margin-left: 26px;">
                            Check this to use the default purple (#6B5DD3) and coral (#FF6B4A) branding
                        </p>
                    </div>

                    <button class="btn" onclick="saveBrandColors()" style="margin-top: 24px; width: 100%;">Save Brand Colors</button>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content">
            <div class="card">
                <h2><span class="card-icon">👤</span> Manage Profile</h2>

                <div class="form-group">
                    <label for="profileFirstName">First Name</label>
                    <input type="text" id="profileFirstName" />
                </div>

                <div class="form-group">
                    <label for="profileLastName">Last Name</label>
                    <input type="text" id="profileLastName" />
                </div>

                <div class="form-group">
                    <label for="profileEmail">Email (cannot be changed)</label>
                    <input type="email" id="profileEmail" disabled style="background: #f0f0f0;" />
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 20px;">Change Password</h3>

                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" />
                </div>

                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" />
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" />
                </div>

                <button class="btn" onclick="updateProfile()">Save Profile Changes</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h2>Article Preview</h2>
                <button class="close-preview" onclick="closePreview()">Close</button>
            </div>
            <div class="preview-body" id="previewBody">
                <!-- Article preview will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Application Password Tutorial Modal -->
    <div id="appPasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeAppPasswordTutorial()">&times;</span>
            <h2>How to Create a WordPress Application Password</h2>

            <div class="tutorial-steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Log into your WordPress admin</h4>
                        <p>Go to <code>https://yoursite.com/wp-admin</code></p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Navigate to Your Profile</h4>
                        <p>Click <strong>Users → Profile</strong> in the WordPress admin menu</p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Scroll to Application Passwords</h4>
                        <p>Find the "Application Passwords" section at the bottom</p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Create New Application Password</h4>
                        <p>Enter a name like "EZWAI Blog Generator" and click <strong>Add New Application Password</strong></p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h4>Copy the Password</h4>
                        <p><strong>⚠️ Important:</strong> Copy the generated password immediately - you won't see it again!</p>
                        <p>It will look like: <code>xxxx xxxx xxxx xxxx xxxx xxxx</code></p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <h4>Paste into Settings</h4>
                        <p>Come back here and paste it into the Application Password field above</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'queries') loadQueries();
            if (tabName === 'schedule') loadSchedule();
            if (tabName === 'articles') loadArticles();
            if (tabName === 'images') loadImages();
            if (tabName === 'billing') loadBilling();
            if (tabName === 'settings') loadSettings();
            if (tabName === 'profile') loadProfileTab();
        }

        // Create Post
        document.getElementById('createPostForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const topic = document.getElementById('postTopic').value;
            const systemPrompt = document.getElementById('systemPrompt').value ||
                'Write a comprehensive, engaging article in a professional but conversational tone.';

            const btn = document.getElementById('createBtn');
            const progressSection = document.getElementById('progressSection');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');

            btn.disabled = true;
            progressSection.classList.add('active');
            statusMessage.innerHTML = '';

            // Simulate progress
            let progress = 0;
            const progressStages = [
                'Analyzing topic...',
                'Generating article structure...',
                'Writing magazine-style content...',
                'Creating hero image...',
                'Generating section images...',
                'Finalizing article...',
                'Publishing to WordPress...'
            ];

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    const stage = Math.floor(progress / (90 / progressStages.length));
                    progressText.textContent = progressStages[stage] || 'Processing...';
                }
            }, 1000);

            try {
                // Get local mode checkbox value
                const localModeCheckbox = document.getElementById('localModeCheckbox');
                const localMode = localModeCheckbox ? localModeCheckbox.checked : false;

                const response = await fetch('/api/create_test_post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        blog_post_idea: topic,
                        system_prompt: systemPrompt,
                        writing_style: systemPrompt,  // Use systemPrompt as writing style for Perplexity
                        local_mode: localMode  // Send local mode preference
                    })
                });

                clearInterval(progressInterval);
                progress = 100;
                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';

                const data = await response.json();

                if (response.ok) {
                    statusMessage.innerHTML = `
                        <div class="status-message status-success">
                            <strong>✅ Success!</strong> Article "${data.title}" has been created and published to WordPress as a draft.
                            ${data.warning ? '<br><br>⚠️ ' + data.warning : ''}
                        </div>
                    `;

                    // Show preview option
                    if (data.content) {
                        statusMessage.innerHTML += `
                            <button class="btn btn-secondary" onclick="showPreview(${JSON.stringify(data.content).replace(/"/g, '&quot;')})" style="margin-top: 15px;">
                                👁️ Preview Article
                            </button>
                        `;
                    }
                } else {
                    throw new Error(data.error || 'Failed to create post');
                }
            } catch (error) {
                clearInterval(progressInterval);
                statusMessage.innerHTML = `
                    <div class="status-message status-error">
                        <strong>❌ Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                setTimeout(() => {
                    progressSection.classList.remove('active');
                }, 3000);
            }
        });

        // Load and save queries
        function loadQueries() {
            fetch('/api/get_specific_queries', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const queryList = document.getElementById('queryList');
                queryList.innerHTML = '';

                for (let i = 1; i <= 10; i++) {
                    const queryValue = data.queries ? (data.queries[i] || '') : (data[i] || '');
                    const styleValue = data.styles ? (data.styles[i] || '') : '';
                    queryList.innerHTML += `
                        <div class="query-item">
                            <input
                                type="text"
                                id="query${i}"
                                placeholder="Topic ${i}"
                                value="${queryValue}"
                                style="flex: 2; margin-right: 10px;"
                            />
                            <select id="style${i}" style="flex: 1;">
                                <option value="">Select Writing Style</option>
                                <option value="Conversational/Personal" ${styleValue === 'Conversational/Personal' ? 'selected' : ''}>Conversational/Personal</option>
                                <option value="Authoritative/Expert" ${styleValue === 'Authoritative/Expert' ? 'selected' : ''}>Authoritative/Expert</option>
                                <option value="Narrative/Storytelling" ${styleValue === 'Narrative/Storytelling' ? 'selected' : ''}>Narrative/Storytelling</option>
                                <option value="Listicle/Scannable" ${styleValue === 'Listicle/Scannable' ? 'selected' : ''}>Listicle/Scannable</option>
                                <option value="Investigative/Journalistic" ${styleValue === 'Investigative/Journalistic' ? 'selected' : ''}>Investigative/Journalistic</option>
                                <option value="How-to/Instructional" ${styleValue === 'How-to/Instructional' ? 'selected' : ''}>How-to/Instructional</option>
                                <option value="Opinion/Commentary" ${styleValue === 'Opinion/Commentary' ? 'selected' : ''}>Opinion/Commentary</option>
                                <option value="Humorous/Satirical" ${styleValue === 'Humorous/Satirical' ? 'selected' : ''}>Humorous/Satirical</option>
                            </select>
                        </div>
                    `;
                }

                updateStats();
            })
            .catch(err => console.error('Error loading queries:', err));
        }

        function saveQueries() {
            const queries = {};
            const styles = {};
            for (let i = 1; i <= 10; i++) {
                const queryValue = document.getElementById(`query${i}`).value;
                const styleValue = document.getElementById(`style${i}`).value;
                if (queryValue) queries[i] = queryValue;
                if (styleValue) styles[i] = styleValue;
            }

            fetch('/api/save_specific_queries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    specific_topic_queries: queries,
                    writing_styles: styles
                })
            })
            .then(res => res.json())
            .then(data => {
                alert('✅ Topics saved successfully!');
                updateStats();
            })
            .catch(err => alert('❌ Error saving topics: ' + err.message));
        }

        // Load and save schedule
        function loadSchedule() {
            fetch('/api/profile', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const schedule = data.schedule || [];
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const scheduleGrid = document.getElementById('scheduleGrid');
                scheduleGrid.innerHTML = '';

                days.forEach((day, index) => {
                    const daySchedule = schedule[index] || { enabled: false, time1: '', time2: '' };
                    scheduleGrid.innerHTML += `
                        <div class="schedule-item">
                            <strong>${day}</strong>
                            <input type="time" id="time1_${index}" value="${daySchedule.time1 || ''}" />
                            <input type="time" id="time2_${index}" value="${daySchedule.time2 || ''}" />
                            <label class="toggle-switch">
                                <input type="checkbox" id="enabled_${index}" ${daySchedule.enabled ? 'checked' : ''} />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    `;
                });
            })
            .catch(err => console.error('Error loading schedule:', err));
        }

        function saveSchedule() {
            const schedule = [];
            for (let i = 0; i < 7; i++) {
                schedule.push({
                    enabled: document.getElementById(`enabled_${i}`).checked,
                    time1: document.getElementById(`time1_${i}`).value,
                    time2: document.getElementById(`time2_${i}`).value
                });
            }

            fetch('/api/save_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ schedule })
            })
            .then(res => res.json())
            .then(data => alert('✅ Schedule saved successfully!'))
            .catch(err => alert('❌ Error saving schedule: ' + err.message));
        }

        // Billing functions
        function loadBilling() {
            loadCredits();
            loadTransactions();
            loadAutoRecharge();
        }

        function loadCredits() {
            fetch('/api/profile', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const credits = Math.floor(data.credit_balance || 0);  // Convert to int

                document.getElementById('creditBalance').textContent = credits;
                document.getElementById('currentBalance').textContent = credits;
                document.getElementById('estimatedArticles').textContent = credits;  // 1:1 ratio
            })
            .catch(err => console.error('Error loading credits:', err));
        }

        function loadTransactions() {
            fetch('/api/profile', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const userId = data.id;
                return fetch(`/api/users/${userId}/transactions`, {
                    credentials: 'include'
                });
            })
            .then(res => res.json())
            .then(data => {
                const history = document.getElementById('transactionHistory');
                if (!data.transactions || data.transactions.length === 0) {
                    history.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No transactions yet</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f8f9ff; font-weight: 600;"><th style="padding: 12px; text-align: left;">Date</th><th style="padding: 12px; text-align: left;">Type</th><th style="padding: 12px; text-align: right;">Amount</th></tr>';

                data.transactions.forEach(t => {
                    const date = new Date(t.created_at).toLocaleDateString();
                    const isPurchase = t.transaction_type === 'purchase' || t.transaction_type === 'welcome';
                    const type = isPurchase ? '💳 Purchase' : '📝 Article';
                    const amountClass = isPurchase ? 'color: #28a745' : 'color: #dc3545';
                    const amount = isPurchase ? `+${t.amount} credits` : `-${Math.abs(t.amount)} credit`;

                    html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 12px;">${date}</td><td style="padding: 12px;">${type}</td><td style="padding: 12px; text-align: right; ${amountClass}; font-weight: 600;">${amount}</td></tr>`;
                });

                html += '</table>';
                history.innerHTML = html;
            })
            .catch(err => {
                document.getElementById('transactionHistory').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px;">Error loading transactions</p>';
            });
        }

        function loadAutoRecharge() {
            fetch('/api/profile', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const enabled = data.auto_recharge_enabled || false;
                document.getElementById('autoRechargeEnabled').checked = enabled;
                document.getElementById('autoRechargeSettings').style.display = enabled ? 'block' : 'none';

                if (data.auto_recharge_threshold) {
                    document.getElementById('autoRechargeThreshold').value = data.auto_recharge_threshold;
                }
                if (data.auto_recharge_amount) {
                    document.getElementById('autoRechargeAmount').value = data.auto_recharge_amount;
                }
            })
            .catch(err => console.error('Error loading auto-recharge:', err));

            // Add event listener for checkbox
            document.getElementById('autoRechargeEnabled').addEventListener('change', function() {
                document.getElementById('autoRechargeSettings').style.display = this.checked ? 'block' : 'none';
            });
        }

        async function purchaseCredits() {
            const amount = parseFloat(document.getElementById('creditPackage').value);

            try {
                const res = await fetch('/api/credits/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ amount })
                });

                const data = await res.json();

                if (data.checkout_url) {
                    // Redirect to Stripe checkout
                    window.location.href = data.checkout_url;
                } else {
                    alert('❌ Error creating checkout session');
                }
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        async function saveAutoRecharge() {
            const enabled = document.getElementById('autoRechargeEnabled').checked;
            const threshold = enabled ? parseFloat(document.getElementById('autoRechargeThreshold').value) : null;
            const amount = enabled ? parseFloat(document.getElementById('autoRechargeAmount').value) : null;

            try {
                const profileRes = await fetch('/api/profile', { credentials: 'include' });
                const profileData = await profileRes.json();
                const userId = profileData.id;

                const res = await fetch(`/api/users/${userId}/auto-recharge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        enabled,
                        threshold,
                        amount
                    })
                });

                const data = await res.json();
                alert('✅ Auto-recharge settings saved!');
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        // Settings functions
        function loadSettings() {
            fetch('/api/profile', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.wordpress_rest_api_url) document.getElementById('wpUrl').value = data.wordpress_rest_api_url;
                if (data.wordpress_app_password) document.getElementById('wpPassword').value = data.wordpress_app_password;
                if (data.system_prompt) document.getElementById('systemPrompt').value = data.system_prompt;

                // Load brand colors
                const useDefault = data.use_default_branding !== false;
                document.getElementById('useDefaultBranding').checked = useDefault;

                const primaryColor = (data.brand_primary_color || '#6B5DD3').toUpperCase();
                const accentColor = (data.brand_accent_color || '#FF6B4A').toUpperCase();
                document.getElementById('brandPrimary').value = primaryColor;
                document.getElementById('brandPrimaryPicker').value = primaryColor;
                document.getElementById('brandAccent').value = accentColor;
                document.getElementById('brandAccentPicker').value = accentColor;

                // Setup color picker event listeners
                setupColorPickers();
            })
            .catch(err => console.error('Error loading settings:', err));
        }

        // Toggle password visibility
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = event.target;

            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🙈 Hide';
            } else {
                field.type = 'password';
                button.textContent = '👁️ Show';
            }
        }

        // Show Application Password tutorial modal
        function showAppPasswordTutorial() {
            document.getElementById('appPasswordModal').style.display = 'block';
        }

        // Close tutorial modal
        function closeAppPasswordTutorial() {
            document.getElementById('appPasswordModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('appPasswordModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Test WordPress connection
        async function testWordPressConnection() {
            const url = document.getElementById('wpUrl').value;
            const appPassword = document.getElementById('wpPassword').value;
            const statusDiv = document.getElementById('wordpressStatus');

            if (!url || !appPassword) {
                showStatus(statusDiv, 'Please enter both WordPress URL and Application Password', 'error');
                return;
            }

            showStatus(statusDiv, 'Testing connection...', 'info');

            try {
                const response = await fetch('/api/test_wordpress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        wordpress_url: url,
                        app_password: appPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(statusDiv, '✅ ' + data.message, 'success');
                } else {
                    showStatus(statusDiv, '❌ ' + data.error, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '❌ Connection failed: ' + error.message, 'error');
            }
        }

        // Save WordPress settings
        async function saveWordPressSettings(event) {
            event.preventDefault();

            const url = document.getElementById('wpUrl').value;
            const appPassword = document.getElementById('wpPassword').value;
            const statusDiv = document.getElementById('wordpressStatus');

            if (!url || !appPassword) {
                showStatus(statusDiv, 'Please fill in all fields', 'error');
                return;
            }

            showStatus(statusDiv, 'Saving...', 'info');

            try {
                const response = await fetch('/api/update_integrations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        wordpress_rest_api_url: url,
                        wordpress_app_password: appPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(statusDiv, '✅ WordPress settings saved successfully!', 'success');
                } else {
                    showStatus(statusDiv, '❌ ' + (data.error || 'Failed to save settings'), 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '❌ Failed to save: ' + error.message, 'error');
            }
        }

        // Legacy function for backward compatibility
        function saveWordPress() {
            // Call the new function
            saveWordPressSettings(new Event('submit'));
        }

        // Helper to show status messages
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message ${type}`;
            element.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Brand customization functions
        function setupColorPickers() {
            const primaryPicker = document.getElementById('brandPrimaryPicker');
            const primaryText = document.getElementById('brandPrimary');
            const accentPicker = document.getElementById('brandAccentPicker');
            const accentText = document.getElementById('brandAccent');

            // Sync color picker -> text input
            primaryPicker.addEventListener('input', function() {
                primaryText.value = this.value.toUpperCase();
            });

            accentPicker.addEventListener('input', function() {
                accentText.value = this.value.toUpperCase();
            });

            // Sync text input -> color picker
            primaryText.addEventListener('input', function() {
                const hexPattern = /^#[0-9A-Fa-f]{6}$/;
                if (hexPattern.test(this.value)) {
                    primaryPicker.value = this.value;
                }
            });

            accentText.addEventListener('input', function() {
                const hexPattern = /^#[0-9A-Fa-f]{6}$/;
                if (hexPattern.test(this.value)) {
                    accentPicker.value = this.value;
                }
            });

            // Handle "Reset to Default" checkbox
            document.getElementById('useDefaultBranding').addEventListener('change', function() {
                if (this.checked) {
                    // Reset to defaults
                    primaryPicker.value = '#6B5DD3';
                    primaryText.value = '#6B5DD3';
                    accentPicker.value = '#FF6B4A';
                    accentText.value = '#FF6B4A';
                }
            });
        }

        function saveBrandColors() {
            const useDefault = document.getElementById('useDefaultBranding').checked;
            const primaryColor = document.getElementById('brandPrimary').value.toUpperCase();
            const accentColor = document.getElementById('brandAccent').value.toUpperCase();

            // Validate hex colors
            const hexPattern = /^#[0-9A-Fa-f]{6}$/;
            if (!hexPattern.test(primaryColor) || !hexPattern.test(accentColor)) {
                alert('❌ Please enter valid hex colors (e.g., #08B2C6)');
                return;
            }

            fetch('/api/update_brand_colors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    use_default_branding: useDefault,
                    brand_primary_color: primaryColor,
                    brand_accent_color: accentColor
                })
            })
            .then(res => res.json())
            .then(data => {
                alert('✅ Brand colors saved! Your custom colors will appear in new articles.');
                // Update the displayed values
                document.getElementById('brandPrimary').value = primaryColor;
                document.getElementById('brandPrimaryPicker').value = primaryColor;
                document.getElementById('brandAccent').value = accentColor;
                document.getElementById('brandAccentPicker').value = accentColor;
            })
            .catch(err => alert('❌ Error: ' + err.message));
        }

        // Update statistics
        function updateStats() {
            fetch('/api/get_specific_queries', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const count = Object.keys(data).filter(key => data[key]).length;
                document.getElementById('activeQueries').textContent = count;
            })
            .catch(err => console.error('Error updating stats:', err));
        }

        // Preview functions
        function showPreview(content) {
            document.getElementById('previewBody').innerHTML = content;
            document.getElementById('previewModal').classList.add('active');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Initialize on load
        // Style Templates Data
        const styleTemplates = [
            {
                name: "Conversational/Personal",
                prompt: "Write this article in a warm, conversational tone as if you're chatting with a friend over coffee. Use first-person perspective ('I', 'my'), share relatable anecdotes or observations, and keep the language casual and approachable. Include rhetorical questions to engage the reader and don't be afraid to show personality or vulnerability."
            },
            {
                name: "Authoritative/Expert",
                prompt: "Write this article as an industry expert addressing professionals in the field. Use a confident, credible tone with precise terminology. Support claims with data, statistics, or research citations. Maintain a professional voice throughout, avoid casual language, and structure arguments logically. The goal is to establish authority and trustworthiness."
            },
            {
                name: "Narrative/Storytelling",
                prompt: "Write this article as a compelling story with a clear beginning, middle, and end. Include vivid descriptions, characters (real or representative), conflict or tension, and resolution. Use sensory details to immerse readers in the experience. Show rather than tell, and create an emotional journey that illustrates your main points through narrative."
            },
            {
                name: "Listicle/Scannable",
                prompt: "Write this article in a highly scannable format with numbered points or clear sections. Use descriptive subheadings, short paragraphs (2-3 sentences max), and bullet points where appropriate. Front-load key information in each section. Make it easy for readers to skim and extract value quickly. Include a brief intro and conclusion."
            },
            {
                name: "Investigative/Journalistic",
                prompt: "Write this article as objective journalism with thorough research and fact-checking. Present multiple perspectives, cite credible sources, and maintain neutrality. Use the inverted pyramid structure (most important information first). Include quotes from experts or stakeholders. Stick to verifiable facts and avoid opinion or speculation."
            },
            {
                name: "How-to/Instructional",
                prompt: "Write this article as a clear, actionable tutorial. Break down the process into numbered steps that are easy to follow. Use imperative verbs ('Click', 'Choose', 'Enter'). Include prerequisites, necessary materials, or tools upfront. Add tips, warnings, or troubleshooting advice where relevant. Focus on helping the reader successfully complete a specific task."
            },
            {
                name: "Opinion/Commentary",
                prompt: "Write this article as a persuasive opinion piece with a strong, clear point of view. State your thesis early and build a logical argument with supporting evidence. Use passionate but respectful language. Anticipate counterarguments and address them. Include examples that support your perspective. The goal is to convince readers or spark thoughtful debate."
            },
            {
                name: "Humorous/Satirical",
                prompt: "Write this article with wit and humor, using irony, exaggeration, or absurdist observations. Include clever wordplay, unexpected comparisons, or satirical takes on the subject. Keep the tone light and entertaining while still conveying your message. Use comedic timing with your sentence structure. Make readers laugh while making your point."
            }
        ];

        function showStyleTemplates() {
            const modal = document.getElementById('styleTemplateModal');
            modal.style.display = 'block';
        }

        function closeStyleTemplates() {
            const modal = document.getElementById('styleTemplateModal');
            modal.style.display = 'none';
        }

        function selectTemplate(index) {
            const template = styleTemplates[index];
            document.getElementById('systemPrompt').value = template.prompt;
            closeStyleTemplates();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('styleTemplateModal');
            if (event.target == modal) {
                closeStyleTemplates();
            }
        }

        // Profile tab functions
        function loadProfileTab() {
            fetch('/api/profile', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('profileFirstName').value = data.first_name || '';
                    document.getElementById('profileLastName').value = data.last_name || '';
                    document.getElementById('profileEmail').value = data.email;
                })
                .catch(err => console.error('Error loading profile tab:', err));
        }

        async function updateProfile() {
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate password change if provided
            if (newPassword) {
                if (!currentPassword) {
                    alert('❌ Please enter your current password');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('❌ New passwords do not match');
                    return;
                }
                if (newPassword.length < 8) {
                    alert('❌ Password must be at least 8 characters');
                    return;
                }
            }

            try {
                const res = await fetch('/api/update_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    alert('✅ Profile updated successfully!');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    loadProfileInfo();  // Refresh name in dropdown
                } else {
                    alert('❌ Error: ' + (data.error || 'Failed to update profile'));
                }
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        // Profile dropdown functions
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.profile-menu-container');
            if (container && !container.contains(event.target)) {
                document.getElementById('profileDropdown').style.display = 'none';
            }
        });

        function openManageProfile() {
            switchTab('profile');
            document.getElementById('profileDropdown').style.display = 'none';
        }

        async function handleLogout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (err) {
                console.error('Logout error:', err);
                window.location.href = '/';
            }
        }

        // Load profile name and avatar on page load
        function loadProfileInfo() {
            fetch('/api/profile', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    const name = data.first_name || data.email.split('@')[0];
                    document.getElementById('profileName').textContent = name;

                    // Set avatar initial (first letter of name)
                    const initial = name.charAt(0).toUpperCase();
                    document.getElementById('profileAvatar').textContent = initial;
                })
                .catch(err => console.error('Error loading profile info:', err));
        }

        // ====================================================================
        // Article Library Functions
        // ====================================================================

        let currentArticlePage = 0;
        const articlesPerPage = 12;

        async function loadArticles(offset = 0) {
            try {
                const searchTerm = document.getElementById('articleSearch').value || '';
                const statusFilter = document.getElementById('articleStatusFilter').value || '';
                const modeFilter = document.getElementById('articleModeFilter').value || '';
                const sortOrder = document.getElementById('articleSortOrder').value || 'newest';

                const params = new URLSearchParams({
                    limit: articlesPerPage,
                    offset: offset,
                    sort: sortOrder
                });

                if (searchTerm) params.append('search', searchTerm);
                if (statusFilter) params.append('status', statusFilter);
                if (modeFilter) params.append('mode', modeFilter);

                const response = await fetch(`/api/users/${window.currentUserId}/articles?${params}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load articles');

                const data = await response.json();
                displayArticles(data.articles);
                displayArticlePagination(data.total, offset);

            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('articleGrid').innerHTML = `
                    <p style="color: #ff6b6b; text-align: center; padding: 40px;">
                        ❌ Error loading articles: ${error.message}
                    </p>
                `;
            }
        }

        function displayArticles(articles) {
            const grid = document.getElementById('articleGrid');

            if (!articles || articles.length === 0) {
                grid.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 40px; grid-column: 1 / -1;">
                        📚 No articles found. Create your first article to see it here!
                    </p>
                `;
                return;
            }

            grid.innerHTML = articles.map(article => `
                <div class="article-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                    ${article.hero_image_url ? `
                        <img src="${article.hero_image_url}" alt="${article.title}" style="width: 100%; height: 200px; object-fit: cover;">
                    ` : ''}
                    <div style="padding: 20px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.2em; color: #333;">${article.title}</h3>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <span style="background: ${getStatusColor(article.status)}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                ${article.status}
                            </span>
                            <span style="background: #6B5DD3; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                ${article.generation_mode}
                            </span>
                        </div>
                        <p style="color: #666; font-size: 0.9em; margin: 10px 0;">
                            📝 ${article.word_count || 0} words | 📅 ${new Date(article.created_at).toLocaleDateString()}
                        </p>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="viewArticle(${article.id})" style="flex: 1; padding: 10px; background: #6B5DD3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                👁️ View
                            </button>
                            ${article.wordpress_url ? `
                                <a href="${article.wordpress_url}" target="_blank" style="flex: 1; padding: 10px; background: #4CAF50; color: white; text-align: center; text-decoration: none; border-radius: 8px;">
                                    🔗 WordPress
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'published': '#4CAF50',
                'draft': '#FF9800',
                'local': '#2196F3',
                'failed': '#F44336'
            };
            return colors[status] || '#666';
        }

        function displayArticlePagination(total, currentOffset) {
            const pagination = document.getElementById('articlePagination');
            const totalPages = Math.ceil(total / articlesPerPage);
            const currentPage = Math.floor(currentOffset / articlesPerPage);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            if (currentPage > 0) {
                html += `<button onclick="loadArticles(${(currentPage - 1) * articlesPerPage})" style="padding: 10px 15px; background: #6B5DD3; color: white; border: none; border-radius: 8px; cursor: pointer;">← Previous</button>`;
            }

            html += `<span style="padding: 10px 15px;">Page ${currentPage + 1} of ${totalPages}</span>`;

            if (currentPage < totalPages - 1) {
                html += `<button onclick="loadArticles(${(currentPage + 1) * articlesPerPage})" style="padding: 10px 15px; background: #6B5DD3; color: white; border: none; border-radius: 8px; cursor: pointer;">Next →</button>`;
            }

            pagination.innerHTML = html;
        }

        async function viewArticle(articleId) {
            try {
                const response = await fetch(`/api/users/${window.currentUserId}/articles/${articleId}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load article');

                const article = await response.json();

                // Open article in new window
                const newWindow = window.open('', '_blank');
                newWindow.document.write(article.content_html);
                newWindow.document.close();

            } catch (error) {
                alert(`Error loading article: ${error.message}`);
            }
        }

        function searchArticles() {
            loadArticles(0);
        }

        function filterArticles() {
            loadArticles(0);
        }

        // ====================================================================
        // Image Library Functions
        // ====================================================================

        let currentImagePage = 0;
        const imagesPerPage = 24;

        async function loadImages(offset = 0) {
            try {
                const searchTerm = document.getElementById('imageSearch').value || '';
                const typeFilter = document.getElementById('imageTypeFilter').value || '';
                const sortOrder = document.getElementById('imageSortOrder').value || 'newest';

                const params = new URLSearchParams({
                    limit: imagesPerPage,
                    offset: offset,
                    sort: sortOrder
                });

                if (searchTerm) params.append('search', searchTerm);
                if (typeFilter) params.append('type', typeFilter);

                const response = await fetch(`/api/users/${window.currentUserId}/images?${params}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load images');

                const data = await response.json();
                displayImages(data.images);
                displayImagePagination(data.total, offset);

            } catch (error) {
                console.error('Error loading images:', error);
                document.getElementById('imageGrid').innerHTML = `
                    <p style="color: #ff6b6b; text-align: center; padding: 40px;">
                        ❌ Error loading images: ${error.message}
                    </p>
                `;
            }
        }

        function displayImages(images) {
            const grid = document.getElementById('imageGrid');

            if (!images || images.length === 0) {
                grid.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 40px; grid-column: 1 / -1;">
                        🖼️ No images found. Generate articles to see images here!
                    </p>
                `;
                return;
            }

            grid.innerHTML = images.map(image => `
                <div class="image-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" onclick="viewImageDetail(${image.id})">
                    <img src="${image.image_url}" alt="Generated image" style="width: 100%; height: 200px; object-fit: cover;">
                    <div style="padding: 15px;">
                        <span style="background: ${image.image_type === 'hero' ? '#FF6B4A' : '#6B5DD3'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                            ${image.image_type}
                        </span>
                        <p style="color: #666; font-size: 0.85em; margin: 10px 0 0 0; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            ${image.prompt}
                        </p>
                        <p style="color: #999; font-size: 0.75em; margin: 8px 0 0 0;">
                            ${new Date(image.created_at).toLocaleDateString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function displayImagePagination(total, currentOffset) {
            const pagination = document.getElementById('imagePagination');
            const totalPages = Math.ceil(total / imagesPerPage);
            const currentPage = Math.floor(currentOffset / imagesPerPage);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            if (currentPage > 0) {
                html += `<button onclick="loadImages(${(currentPage - 1) * imagesPerPage})" style="padding: 10px 15px; background: #6B5DD3; color: white; border: none; border-radius: 8px; cursor: pointer;">← Previous</button>`;
            }

            html += `<span style="padding: 10px 15px;">Page ${currentPage + 1} of ${totalPages}</span>`;

            if (currentPage < totalPages - 1) {
                html += `<button onclick="loadImages(${(currentPage + 1) * imagesPerPage})" style="padding: 10px 15px; background: #6B5DD3; color: white; border: none; border-radius: 8px; cursor: pointer;">Next →</button>`;
            }

            pagination.innerHTML = html;
        }

        async function viewImageDetail(imageId) {
            try {
                const response = await fetch(`/api/users/${window.currentUserId}/images/${imageId}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load image');

                const image = await response.json();

                // Create modal to show image details
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                        <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2em;">×</button>
                        <img src="${image.image_url}" alt="Image" style="width: 100%; max-height: 60vh; object-fit: contain;">
                        <div style="padding: 30px;">
                            <div style="margin-bottom: 20px;">
                                <span style="background: ${image.image_type === 'hero' ? '#FF6B4A' : '#6B5DD3'}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.9em;">
                                    ${image.image_type}
                                </span>
                                <span style="background: #4CAF50; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.9em; margin-left: 10px;">
                                    ${image.model}
                                </span>
                            </div>
                            <h3 style="margin: 15px 0 10px 0;">📝 Prompt</h3>
                            <p style="color: #666; line-height: 1.6;">${image.prompt}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                                <div>
                                    <strong>Aspect Ratio:</strong><br>${image.aspect_ratio || 'N/A'}
                                </div>
                                <div>
                                    <strong>Cost:</strong><br>$${image.cost_usd.toFixed(4)}
                                </div>
                                <div>
                                    <strong>Created:</strong><br>${new Date(image.created_at).toLocaleString()}
                                </div>
                            </div>
                            <a href="${image.image_url}" download target="_blank" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #6B5DD3; color: white; text-decoration: none; border-radius: 8px;">
                                ⬇️ Download Image
                            </a>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

            } catch (error) {
                alert(`Error loading image: ${error.message}`);
            }
        }

        function searchImages() {
            loadImages(0);
        }

        function filterImages() {
            loadImages(0);
        }

        window.addEventListener('load', () => {
            loadSettings();
            updateStats();
            loadCredits(); // Load credit balance for display
            loadProfileInfo(); // Load profile info for dropdown
        });
    </script>

    <!-- Style Template Modal -->
    <div id="styleTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeStyleTemplates()">&times;</span>
                <h2>📋 Choose a Writing Style Template</h2>
            </div>
            <div class="modal-body">
                <div id="templateList">
                    <div class="template-item" onclick="selectTemplate(0)">
                        <div class="template-name">Conversational/Personal</div>
                        <div class="template-preview">Warm, friendly tone with first-person perspective and relatable anecdotes...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(1)">
                        <div class="template-name">Authoritative/Expert</div>
                        <div class="template-preview">Professional, credible tone with data-driven insights and industry expertise...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(2)">
                        <div class="template-name">Narrative/Storytelling</div>
                        <div class="template-preview">Compelling story structure with vivid descriptions and emotional journey...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(3)">
                        <div class="template-name">Listicle/Scannable</div>
                        <div class="template-preview">Highly scannable format with numbered points and short paragraphs...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(4)">
                        <div class="template-name">Investigative/Journalistic</div>
                        <div class="template-preview">Objective journalism with multiple perspectives and credible sources...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(5)">
                        <div class="template-name">How-to/Instructional</div>
                        <div class="template-preview">Clear tutorial with step-by-step instructions and actionable guidance...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(6)">
                        <div class="template-name">Opinion/Commentary</div>
                        <div class="template-preview">Persuasive opinion piece with strong arguments and supporting evidence...</div>
                    </div>
                    <div class="template-item" onclick="selectTemplate(7)">
                        <div class="template-name">Humorous/Satirical</div>
                        <div class="template-preview">Witty, entertaining style with wordplay and satirical observations...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>